(function(e){var t={};var n={init:function(n){t=e.extend({baseUrl:"http://api.conductrics.com",apiKey:null,agent:null,session:null,timeout:1e3},n);return this},toggle:function(t,i){var s=e(this);var o=e.extend({choices:["show","hide"],initial:"hide"},t);r(o.initial,s);n["get-decision"](o,function(e){r(e.code,s)});return this},"apply-helpers":function(t,n){var r=e(this);var i=e.extend({helpers:[]},t);for(var s in i.helpers){var o=i.helpers[s];if(o.selector&&o.helper&&o.options){if(["toggle","choose-best"].indexOf(o.helper)>=0){}}}},"choose-best":function(t,i){var s=e(this);var o=e.extend({choices:s.length,initial:"hide"},t);r(o.initial,s);n["get-decision"](o,function(e){var t=parseInt(e.code);r("show",s.eq(t))});return this},"redirect-to-best-url":function(t,r,i){var s=e.extend({},r);s.choices=t.length;var o=t[0];n["get-decision"](s,function(e){if(e.code!=null){o=t[e.code]}window.location.replace(o)});return this},autowire:function(t,n){var r=e(this).hide();var i=e.extend({},t);var s=findAutowirableAgents(r.selector);for(var o in s){(function(t,n){if(n&&n.choices&&n.choices.length>=2){e.conductrics("get-decision",{agent:t,choices:n.choices.join(",")},function(n){var i=r.selector+'[data-conductrics-agent="'+t+'"][data-conductrics-choice="'+n.code+'"]';e(i).show()})}})(o,s[o])}},"get-decision":function(n,r){var n=e.extend({agent:t.agent,session:t.session,decision:"decision-1",choices:["a","b"]},n);if(!ensure(n,["agent"])){return}if(!ensure(t,["baseUrl","apiKey"])){return}var i=constructUrl(["decisions",n.choices.toString()],n);var s={apikey:t.apiKey};if(n.session){s.session=n.session}if(typeof n.choices=="number"){var o={code:0}}else if(typeof n.choices.join=="function"){var o={code:n.choices[0]}}doAjax(i,"GET",s,function(e,t,i){if(t=="success"){o=e.decisions[n.decision]}if(typeof r=="function"){r.apply(this,[o,e,t,i])}})},"send-goal":function(n,r){var n=e.extend({agent:t.agent,session:t.session,reward:null,goal:"goal-1"},n);var i=constructUrl(["goal",n.goal],n);var s={apikey:t.apiKey};if(n.reward){s.reward=n.reward}if(n.session){s.session=n.session}if(n.goal){s.goal=n.goal}doAjax(i,"POST",s,function(e,t,n){if(typeof r=="function"){r.apply(this,[e,t,n])}})},"expire-session":function(n,r){var n=e.extend({agent:t.agent,session:t.session},n);var i=constructUrl(["expire"],n);var s={apikey:t.apiKey};if(n.session){s.session=n.session}doAjax(i,"GET",s,function(e,t,n){if(typeof r=="function"){r.apply(this,[e,t,n])}})}},r=function(e,t){switch(e){case"show":t.show();break;case"hide":t.hide();break}};constructUrl=function(e,n){var r=[t.baseUrl,t.owner,n.agent].concat(e).join("/");return r};complain=function(e){console.log(e)};ensure=function(e,t){for(var n in t){var r=t[n];if(e[r]==undefined){complain("Conductrics plugin cannot proceed because option '"+r+"' is not provided.");return false}}return true};getWorkaroundId=function(){var t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890".split("");var n=function(e){return e[Math.floor(Math.random()*e.length)]};var r=function(e,r){if(r==null)r="";while(r.length<e){r+=n(t)}return r};var i=e.cookie("conductrics-id");if(i==undefined){i=r(32,"cond-");e.cookie("conductrics-id",i)}return i};findAutowirableAgents=function(t){var n={};e(t).each(function(){var t=e(this).attr("data-conductrics-agent");var r=e(this).attr("data-conductrics-choice");if(validCode(t)){if(!n[t]){n[t]={choices:[]}}var i=n[t].choices;if(!validCode(r)){r="experience-"+"abcdefghijklmnopqrstuvwxyz"[i.length];e(this).attr("data-conductrics-choice",r)}n[t].choices.push(r)}});for(var r in n){if(n[r].choices.length==1){n[r].choices.push("nothing")}}return n};validCode=function(e){return e!=null&&e.length>0&&e.length<25&&!/[^0-9A-Za-z_-]/.test(e)};doAjax=function(n,r,i,s){if(i.session==null&&window.XDomainRequest){i.session=getWorkaroundId()}e.ajax({url:n,type:r,dataType:"json",data:i,success:s,timeout:t.timeout,error:function(e,t,n){s(null,t,e)},xhrFields:{withCredentials:true}})};e.conductrics=e.fn.conductrics=function(t){if(n[t]){return n[t].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof t==="object"||!t){return n.init.apply(this,arguments)}else{e.error("Method "+t+" does not exist on jQuery.conductrics")}}})(jQuery);(function(e,t,n){function i(e){return e}function s(e){return decodeURIComponent(e.replace(r," "))}var r=/\+/g;var o=e.cookie=function(r,u,a){if(u!==n){a=e.extend({},o.defaults,a);if(u===null){a.expires=-1}if(typeof a.expires==="number"){var f=a.expires,l=a.expires=new Date;l.setDate(l.getDate()+f)}u=o.json?JSON.stringify(u):String(u);return t.cookie=[encodeURIComponent(r),"=",o.raw?u:encodeURIComponent(u),a.expires?"; expires="+a.expires.toUTCString():"",a.path?"; path="+a.path:"",a.domain?"; domain="+a.domain:"",a.secure?"; secure":""].join("")}var c=o.raw?i:s;var h=t.cookie.split("; ");for(var p=0,d=h.length;p<d;p++){var v=h[p].split("=");if(c(v.shift())===r){var m=c(v.join("="));return o.json?JSON.parse(m):m}}return null};o.defaults={};e.removeCookie=function(t,n){if(e.cookie(t)!==null){e.cookie(t,null,n);return true}return false}})(jQuery,document);(function(e){if(window.XDomainRequest){e.ajaxTransport(function(t){if(t.crossDomain&&t.async){if(t.timeout){t.xdrTimeout=t.timeout;delete t.timeout}var n;return{send:function(r,i){function o(t,r,s,o){n.onload=n.onerror=n.ontimeout=n.onprogress=e.noop;n=undefined;i(t,r,s,o)}n=new XDomainRequest;n.open(t.type,t.url);n.onload=function(){o(200,"OK",{text:n.responseText},"Content-Type: "+n.contentType)};n.onerror=function(){o(404,"Not Found")};n.onprogress=function(){};if(t.xdrTimeout){n.ontimeout=function(){o(0,"timeout")};n.timeout=t.xdrTimeout}n.send(t.hasContent&&t.data||null)},abort:function(){if(n){n.onerror=e.noop();n.abort()}}}}})}})(jQuery)
