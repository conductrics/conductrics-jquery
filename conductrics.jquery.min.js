(function(e){var t={};var n={init:function(n){t=e.extend({baseUrl:"http://api.conductrics.com",apiKey:null,agent:null,session:null,timeout:1e3,caching:false,cachingMaxAge:30*60},n);storageMaintain();return this},toggle:function(t,i){var s=e(this);var o=e.extend({choices:["show","hide"],initial:"hide"},t);r(o.initial,s);n["get-decision"](o,function(e){r(e.code,s)});return this},"apply-helpers":function(t,n){var r=e(this);var i=e.extend({helpers:[]},t);for(var s in i.helpers){var o=i.helpers[s];if(o.selector&&o.helper&&o.options){if(e.inArray(o.helper,["toggle","choose-best"])>=0){}}}},"choose-best":function(t,i){var s=e(this);var o=e.extend({choices:s.length,initial:"hide"},t);r(o.initial,s);n["get-decision"](o,function(e){var t=parseInt(e.code);r("show",s.eq(t))});return this},"redirect-to-best-url":function(t,r,i){var s=e.extend({},r);s.choices=t.length;var o=t[0];n["get-decision"](s,function(e){if(e.code!=null){o=t[e.code]}window.location.replace(o)});return this},autowire:function(t,n){var r=e(this).hide();var i=e.extend({autoReward:true},t);var s=findAutowirableAgents(r.selector);var o=e("body").attr("data-conductrics-features");for(var u in s){(function(t,n){if(n&&n.choices&&n.choices.length>=2){e.conductrics("get-decision",{agent:t,choices:n.choices.join(","),features:o},function(n){var i=r.selector+'[data-conductrics-agent="'+t+'"][data-conductrics-choice="'+n.code+'"]';e(i).show()})}})(u,s[u])}if(i.autoReward){rewards=e("body").attr("data-conductrics-reward-onload");if(rewards){rewards=rewards.split(",");for(var a in rewards){var f=rewards[a].split(":");if(f.length>=1){goalOptions={agent:f[0],goal:f[1],reward:f[2]};e.conductrics("send-goal",goalOptions,function(){complain("reward sent for ",goalOptions)})}}}}},"get-decision":function(n,r){var n=e.extend({agent:t.agent,session:t.session,decision:"decision-1",choices:["a","b"]},n);if(!ensure(n,["agent"])){return}if(!ensure(t,["baseUrl","owner","apiKey"])){return}var i=constructUrl(["decisions",n.choices.toString()],n);var s={apikey:t.apiKey};if(n.session){s.session=n.session}if(n.features){s.features=sanitizeCodesStr(n.features)}var o;if(typeof n.choices=="number"){o={code:0}}else if(typeof n.choices.join=="function"){o={code:n.choices[0]}}if(t.caching){var u=storageRead(n,"dec");if(u&&u[n.decision]){o=u[n.decision];if(typeof r=="function"){r.apply(this,[o,null,"stored",null]);return}}}doAjax(i,"GET",s,function(e,i,s){if(i=="success"){o=e.decisions[n.decision];if(t.caching&&o){storageWrite(n,"dec",e.decisions);console.log("write",e.decisions)}}if(typeof r=="function"){r.apply(this,[o,e,i,s])}})},"send-goal":function(n,r){var n=e.extend({agent:t.agent,session:t.session,reward:null,goal:"goal-1"},n);var i=constructUrl(["goal",n.goal],n);var s={apikey:t.apiKey};if(n.reward){s.reward=n.reward}if(n.session){s.session=n.session}doAjax(i,"POST",s,function(e,t,n){if(typeof r=="function"){r.apply(this,[e,t,n])}})},"expire-session":function(n,r){var n=e.extend({agent:t.agent,session:t.session},n);var i=constructUrl(["expire"],n);var s={apikey:t.apiKey};if(n.session){s.session=n.session}doAjax(i,"GET",s,function(e,t,n){if(typeof r=="function"){r.apply(this,[e,t,n])}})}},r=function(e,t){switch(e){case"show":t.show();break;case"hide":t.hide();break}};constructUrl=function(e,n){var r=[t.baseUrl,t.owner,n.agent].concat(e).join("/");return r};complain=function(){if(console&&console.log){console.log(arguments)}};ensure=function(e,t){for(var n in t){var r=t[n];if(e[r]==undefined){complain("Conductrics plugin cannot proceed because option '"+r+"' is not provided.");return false}}return true};getWorkaroundId=function(){var t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890".split("");var n=function(e){return e[Math.floor(Math.random()*e.length)]};var r=function(e,r){if(r==null)r="";while(r.length<e){r+=n(t)}return r};var i=e.cookie("conductrics-id");if(i==undefined){i=r(32,"cond-");e.cookie("conductrics-id",i)}return i};findAutowirableAgents=function(t){var n={};e(t).each(function(){var t=e(this).attr("data-conductrics-agent");var r=e(this).attr("data-conductrics-choice");if(validCode(t)){if(!n[t]){n[t]={choices:[]}}var i=n[t].choices;if(!validCode(r)){r="experience-"+"abcdefghijklmnopqrstuvwxyz"[i.length];e(this).attr("data-conductrics-choice",r)}n[t].choices.push(r)}});for(var r in n){if(n[r].choices.length==1){n[r].choices.push("nothing")}}return n};validCode=function(e){return e!=null&&e.length>0&&e.length<25&&!/[^0-9A-Za-z_-]/.test(e)};sanitizeCodesStr=function(e){if(!e)return"";return sanitizeCodes(e.split(",")).join(",")};sanitizeCodes=function(e){if(!e)return[];result=[];for(var t in e){if(validCode(e[t])){result.push(e[t])}}return result};supportsHtmlLocalStorage=function(){if(t.caching!="localStorage")return false;try{return"localStorage"in window&&window["localStorage"]!==null}catch(e){return false}};storageKey=function(e,n){var r=[];var i=["baseUrl","owner","agent","session"];for(var s in i){if(e[i[s]]!=null){r.push(e[i[s]])}else if(t[i[s]]!=null){r.push(t[i[s]])}}if(n){r.push(n)}return r.join(":")};storageRead=function(e,t,n){if(!supportsHtmlLocalStorage()){return n}var r=localStorage;var i=storageKey(e,t);var s=r.getItem(i);if(s){var o=JSON.parse(s);if(o.val){return o.val}}return n};storageWrite=function(e,t,n){if(!supportsHtmlLocalStorage()){return}var r=localStorage;var i=storageKey(e,t);var s={ts:(new Date).getTime(),val:n};r.setItem(i,JSON.stringify(s))};storageMaintain=function(){if(!supportsHtmlLocalStorage()){return}var e=localStorage;for(var n=0;n<e.length;n++){var r=e.key(n);if(r.indexOf([t.baseUrl,t.owner].join(":"))==0){var i=e.getItem(r);if(i){var s=JSON.parse(i);if(s.ts&&s.ts+t.cachingMaxAge*1e3<(new Date).getTime()){e.removeItem(r);console.log("removed key",r)}}}}};doAjax=function(n,r,i,s){if(i.session==null&&window.XDomainRequest){i.session=getWorkaroundId()}e.ajax({url:n,type:r,dataType:"json",data:i,success:s,timeout:t.timeout,error:function(e,t,n){s(null,t,e)},xhrFields:{withCredentials:true}})};e.conductrics=e.fn.conductrics=function(t){if(n[t]){return n[t].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof t==="object"||!t){return n.init.apply(this,arguments)}else{e.error("Method "+t+" does not exist on jQuery.conductrics")}}})(jQuery);(function(e,t,n){function i(e){return e}function s(e){return decodeURIComponent(e.replace(r," "))}var r=/\+/g;var o=e.cookie=function(r,u,a){if(u!==n){a=e.extend({},o.defaults,a);if(u===null){a.expires=-1}if(typeof a.expires==="number"){var f=a.expires,l=a.expires=new Date;l.setDate(l.getDate()+f)}u=o.json?JSON.stringify(u):String(u);return t.cookie=[encodeURIComponent(r),"=",o.raw?u:encodeURIComponent(u),a.expires?"; expires="+a.expires.toUTCString():"",a.path?"; path="+a.path:"",a.domain?"; domain="+a.domain:"",a.secure?"; secure":""].join("")}var c=o.raw?i:s;var h=t.cookie.split("; ");for(var p=0,d=h.length;p<d;p++){var v=h[p].split("=");if(c(v.shift())===r){var m=c(v.join("="));return o.json?JSON.parse(m):m}}return null};o.defaults={};e.removeCookie=function(t,n){if(e.cookie(t)!==null){e.cookie(t,null,n);return true}return false}})(jQuery,document);(function(e){if(window.XDomainRequest){e.ajaxTransport(function(t){if(t.crossDomain&&t.async){if(t.timeout){t.xdrTimeout=t.timeout;delete t.timeout}var n;return{send:function(r,i){function o(t,r,s,o){n.onload=n.onerror=n.ontimeout=n.onprogress=e.noop;n=undefined;i(t,r,s,o)}n=new XDomainRequest;n.open(t.type,t.url);n.onload=function(){o(200,"OK",{text:n.responseText},"Content-Type: "+n.contentType)};n.onerror=function(){o(404,"Not Found")};n.onprogress=function(){};if(t.xdrTimeout){n.ontimeout=function(){o(0,"timeout")};n.timeout=t.xdrTimeout}n.send(t.hasContent&&t.data||null)},abort:function(){if(n){n.onerror=e.noop();n.abort()}}}}})}})(jQuery)
